# Upsun Configuration for SynthralOS Automation Platform
# Documentation: https://docs.upsun.com/

applications:
  backend:
    type: nodejs:20
    hooks:
      build: |
        # Upsun may only install production dependencies, so force install dev deps
        # Remove node_modules first to ensure clean install
        rm -rf node_modules package-lock.json
        # Install all dependencies including dev dependencies
        npm install --legacy-peer-deps --no-audit --no-fund
        # Verify TypeScript package is installed
        if [ ! -d node_modules/typescript ]; then
          echo "Installing TypeScript explicitly..."
          npm install --save-dev typescript --legacy-peer-deps --no-audit --no-fund
        fi
        # Verify TypeScript is installed
        if [ ! -d node_modules/typescript ]; then
          echo "ERROR: TypeScript package not found after installation"
          exit 1
        fi
        echo "✓ TypeScript package found"
        # Use npx to run build commands (npx will find tsc even if symlink is missing)
        # Build shared package
        cd shared && npx tsc --project tsconfig.json && cd ..
        # Build backend
        mkdir -p backend/dist && npx tsc -p tsconfig.backend.json || (echo 'TypeScript compilation had errors, but continuing...') && (if [ -f backend/dist/src/index.js ]; then mv backend/dist/src/index.js backend/dist/index.js && echo '✓ Moved backend/dist/src/index.js to backend/dist/index.js'; fi) && (test -f backend/dist/index.js && echo '✓ backend/dist/index.js exists' || echo '✗ backend/dist/index.js NOT found')
        # Build frontend
        (npx tsc -p tsconfig.frontend.json || true) && npx vite build --config vite.config.ts && mkdir -p backend/public && sh -c 'if [ -d frontend/dist ] && [ -n "$(ls -A frontend/dist 2>/dev/null)" ]; then cp -r frontend/dist/* backend/public/ 2>/dev/null || true; cp -r frontend/dist/.[!.]* backend/public/ 2>/dev/null || true; elif [ -d dist ] && [ -n "$(ls -A dist 2>/dev/null)" ]; then cp -r dist/* backend/public/ 2>/dev/null || true; cp -r dist/.[!.]* backend/public/ 2>/dev/null || true; else echo "Error: Could not find frontend build output"; ls -la frontend/ 2>&1; ls -la dist 2>&1 || true; exit 1; fi'
    web:
      commands:
        start: npm start
      upstream:
        socket_family: tcp
        protocol: http
      locations:
        "/":
          passthru: true
        "/api":
          passthru: true
        "/health":
          passthru: true
    variables:
      env:
        NODE_ENV: production
        PORT: "4000"
        HOST: "0.0.0.0"
        VITE_API_URL: ""
        CORS_ORIGIN: ""
        OTEL_ENABLED: "false"
        OTEL_SERVICE_NAME: sos-backend
        OTEL_SERVICE_VERSION: "1.0.0"
        POSTHOG_HOST: https://app.posthog.com
        RUDDERSTACK_DATA_PLANE_URL: https://hosted.rudderlabs.com
        STACKSTORM_ENABLED: "false"
        NANGO_HOST: https://api.nango.dev
    relationships:
      redis: redis:valkey

services:
  redis:
    type: valkey-persistent:8.0

routes:
  "https://{default}/":
    type: upstream
    upstream: backend:http

# Environment variables that need to be set in Upsun dashboard:
# - DATABASE_URL (Supabase PostgreSQL connection string)
# - CLERK_SECRET_KEY
# - CLERK_PUBLISHABLE_KEY
# - OPENAI_API_KEY
# - ANTHROPIC_API_KEY
# - RESEND_API_KEY
# - NANGO_SECRET_KEY
# - SUPABASE_URL
# - SUPABASE_ANON_KEY
# - SUPABASE_SERVICE_ROLE_KEY
# - OTEL_EXPORTER_OTLP_ENDPOINT (if using OpenTelemetry)
# - POSTHOG_API_KEY (if using PostHog)
# - RUDDERSTACK_WRITE_KEY (if using RudderStack)
# - STACKSTORM_API_URL (if using StackStorm)
# - STACKSTORM_API_KEY (if using StackStorm)
# - JWT_SECRET (auto-generated if not set)

